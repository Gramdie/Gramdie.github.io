const SHEETDB_URL = "https://sheetdb.io/api/v1/9sv7pjhrhpwbq";

// Seleção de elementos do DOM
const gamesGrid = document.getElementById('games-grid');
const loadingTrigger = document.getElementById('loading-trigger');
const themeBtn = document.getElementById('themeBtn');
const themeIcon = document.getElementById('themeIcon');
const addGameBtn = document.getElementById('addGameBtn');
const searchInput = document.getElementById('searchInput');

// --- 1. LÓGICA DE TEMA (DARK/LIGHT) ---
function aplicarTema() {
    const temaSalvo = localStorage.getItem('theme');
    if (temaSalvo === 'light') {
        document.body.classList.add('light-mode');
        if (themeIcon) themeIcon.className = 'fas fa-moon';
    }
}

if (themeBtn) {
    themeBtn.onclick = () => {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        if (themeIcon) themeIcon.className = isLight ? 'fas fa-moon' : 'fas fa-sun';
    };
}

// --- 2. LÓGICA DE BUSCA (REDIRECIONAMENTO) ---
if (searchInput) {
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const valor = searchInput.value.trim();
            if (valor) {
                window.location.href = `pages/search.html?query=${encodeURIComponent(valor)}`;
            }
        }
    });
}

// --- 3. BOTÃO ADICIONAR ---
if (addGameBtn) {
    addGameBtn.onclick = () => {
        window.location.href = 'pages/creategame.html';
    };
}

// --- 4. RENDERIZAÇÃO DOS CARDS DO BANCO DE DADOS ---
async function carregarCatalogo() {
    try {
        const response = await fetch(SHEETDB_URL);
        if (!response.ok) throw new Error("Erro na rede");
        
        const data = await response.json();

        // Esconde o loading
        if (loadingTrigger) loadingTrigger.style.display = 'none';
        if (!gamesGrid) return;

        gamesGrid.innerHTML = '';

        // Exibe do mais novo para o mais antigo
        [...data].reverse().forEach(jogo => {
            const card = document.createElement('div');
            card.className = 'game-card';
            
            // Redirecionamento para a página do post
            card.onclick = () => {
                window.location.href = `pages/post.html?id=${jogo.id}`;
            };

            // Processamento de Gêneros
            const generosRaw = jogo.genres || "Geral";
            const tagsHTML = generosRaw.split(',')
                .map(g => `<span class="tag-genre">${g.trim()}</span>`)
                .join('');

            // Identificação do Provedor
            const linkDownload = (jogo.mainLink || "").toLowerCase();
            let provedorNome = "Cloud Store";
            if (linkDownload.includes('mediafire')) provedorNome = "Mediafire";
            if (linkDownload.includes('mega.nz')) provedorNome = "Mega.nz";
            if (linkDownload.includes('drive.google')) provedorNome = "Google Drive";

            // --- LÓGICA DA TAG SUSPICIOUS ---
            // Se a coluna 'suspicious' for "true" ou "1", cria a tag vermelha
            let tagSuspicious = "";
            if (jogo.suspicious === "true" || jogo.suspicious === "1") {
                tagSuspicious = `
                    <div style="background: #ff4757; color: white; font-size: 10px; font-weight: bold; padding: 4px 10px; border-radius: 6px; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(255,71,87,0.3);">
                        <i class="fas fa-exclamation-triangle"></i> SUSPICIOUS
                    </div>
                `;
            }

            card.innerHTML = `
                <img src="${jogo.banner}" alt="${jogo.title}" onerror="this.src='https://placehold.co/600x400?text=Imagem+Indisponível'">
                <div class="card-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span class="post-date">${jogo.date || 'Recente'}</span>
                        ${tagSuspicious}
                    </div>
                    <h3 class="game-title">${jogo.title || 'Título Indisponível'}</h3>
                    <p class="card-desc">${jogo.description || 'Nenhuma descrição disponível para este jogo.'}</p>
                    <div class="genre-tags">${tagsHTML}</div>
                    <div class="provider-tags">
                        <span class="tag-provider">
                            <i class="fas fa-cloud"></i> ${provedorNome}
                        </span>
                        <span class="tag-provider" style="color: #2ecc71;">
                            <i class="fas fa-check-circle"></i> Online
                        </span>
                    </div>
                    <div class="btn-details" style="background: var(--blue); color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 14px; margin-top: auto;">
                        Ver Detalhes
                    </div>
                </div>
            `;
            gamesGrid.appendChild(card);
        });

    } catch (err) {
        console.error("Erro ao carregar jogos:", err);
        if (loadingTrigger) {
            loadingTrigger.innerHTML = `
                <i class="fas fa-exclamation-circle" style="color: #ff4757; font-size: 24px;"></i>
                <p>Erro ao sincronizar dados. Verifique sua conexão.</p>
            `;
        }
    }
}

// Inicialização
document.addEventListener('DOMContentLoaded', () => {
    aplicarTema();
    carregarCatalogo();
});
